#!/usr/bin/python

from lxml import html
from selenium import webdriver
from datetime import datetime
import time, sys, os
sys.path.append(os.path.abspath('').replace('ebates', 'functions'))
from functions import csv_file, mongo_db, spider, spider_sel, data_cleaner


def double_cash_back(collection, file_h):
    url = 'https://www.ebates.com/athleisure-deals.htm'
    response = spider(url)
    data = html.fromstring(response.text)
    for e in  data.xpath('.//div[@id="coupons"]/div[contains(@class, "coupon")]'):
        item = dict()
        item['url'] = e.xpath('.//a/@href')[0]
        #item['cashback'] = e.xpath('./span/text()')[1].strip().split(' ')[0]
        #item['timestamp'] = datetime.utcnow().strftime("%Y-%m-%d %H:%M:%S")
        #collection.insert(item)
        #line = item['url'] + ',' + item['cashback'] + ',' + item['timestamp'] + '\n'
        #file_h.write(line)
        print item['url']

def hot_deals(collection, file_h):
    url = 'https://www.ebates.com/deals.htm'
    response = spider(url)
    data = html.fromstring(response.text)
    for e in data.xpath('.//div[@id="coupons"]/div[@class="coupon-blk logo-blk blk border-b pad-30"]'):
        item = dict()
        item['url'] = e.xpath('./div[@class="merchlogo flt"]/a/@href')[0].strip('/')
        item['cashback'] = e.xpath('./ul/li/span/text()')[1].split('Cash')[0].strip().strip('+').replace('Up to', '').strip()
        item['timestamp'] = datetime.utcnow().strftime("%Y-%m-%d %H:%M:%S")
        collection.insert(item)
        line = item['url'] + ',' + item['cashback'] + ',' + item['timestamp'] + '\n'
        file_h.write(line)
        print line.strip()

def luxury(collection, file_h):
    url = 'https://www.ebates.com/luxury/all-stores.htm'
    driver = sel_spider(url)
    for e in driver.find_elements_by_xpath('.//ul[@class="store-sort"]/li'):
        item = dict()
        url = e.find_element_by_xpath('./a').get_attribute('href').split('/')
        if 'mytheresa-com' in url: item['url'] = 'mytheresa.com' 
        else: item['url'] =  e.find_element_by_xpath('./a').get_attribute('href').split('/')[-1]
        item['cashback'] = e.find_elements_by_xpath('./a/span')[1].text.replace('Up to ', '').split(' ')[0].strip()
        item['timestamp'] = datetime.utcnow().strftime("%Y-%m-%d %H:%M:%S")
        if item['cashback'] == 'No': continue
        collection.insert(item)
        line = item['url'] + ',' + item['cashback'] + ',' + item['timestamp'] + '\n'
        file_h.write(line)
        print line.strip()

def in_store(collection, file_h):
    url = 'https://www.ebates.com/in-store.htm'
    driver = sel_spider(url)
    for e in driver.find_elements_by_xpath('.//div[@id="clo-offers-cont"]/div'):
        item = dict()
        item['url'] = e.find_element_by_xpath('./img').get_attribute('title')
        item['cashback'] = e.find_elements_by_xpath('./div')[0].text.split(' ')[0]
        item['timestamp'] = datetime.utcnow().strftime("%Y-%m-%d %H:%M:%S")
        collection.insert(item)
        line = item['url'] + ',' + item['cashback'] + ',' + item['timestamp'] + '\n'
        file_h.write(line)
        print line.strip()

    driver.quit()

def main():
    fn = 'ebates'
    fh = csv_file(fn)
    client, coll = mongo_db()

    double_cash_back(coll, fh)
    #time.sleep(5)
    #hot_deals(coll, fh)
    #time.sleep(5)
    #luxury(coll, fh)
    #time.sleep(5)
    #in_store(coll, fh)

    client.close()
    fh.close()

main()

